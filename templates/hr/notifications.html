{% extends "hr/_base.html" %}

{% block title %}Notifications â€¢ HR{% endblock %}

{% block content %}
<header class="card rounded-2xl bg-gray-900/80 p-3 sm:p-4 md:p-5 mb-4 sm:mb-6 border border-gray-800">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4">
    <div>
      <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-white">Notifications</h1>
      <p class="text-gray-400 text-xs sm:text-sm">Branch-scoped applicant updates</p>
    </div>
    <div class="flex items-center gap-3">
      <div class="text-right">
        <p class="text-xs text-gray-500">Unread</p>
        <p class="text-lg font-bold text-red-400" id="unread-count">{{ unread_count }}</p>
      </div>
      {% if unread_count > 0 %}
      <form id="mark-all-read-form" action="{{ url_for('mark_all_hr_notifications_read') }}" method="POST" class="inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="px-3 sm:px-4 py-2 text-xs sm:text-sm bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold flex items-center gap-2 transition-all">
          <i class="fas fa-check-double"></i>
          <span>Mark All as Read</span>
        </button>
      </form>
      {% endif %}
      {% if notifications %}
      <form id="delete-all-form" action="{{ url_for('delete_all_hr_notifications') }}" method="POST" class="inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="px-3 sm:px-4 py-2 text-xs sm:text-sm bg-red-600/20 text-red-300 hover:text-white hover:bg-red-600/30 rounded-lg border border-red-600/30 hover:border-red-600/50 transition-all flex items-center gap-2">
          <i class="fas fa-trash"></i>
          <span>Delete All</span>
        </button>
      </form>
      {% endif %}
    </div>
  </div>
</header>

{% if notifications %}
<section class="card rounded-2xl bg-gray-900/80 p-3 sm:p-4 border border-gray-800">
  <div class="space-y-3" id="notifications-list">
    {% for notif in notifications %}
    <div class="notification-item border border-gray-800 rounded-xl p-3 sm:p-4 transition-all duration-200 {% if not notif.is_read %}bg-gray-800/50 border-l-4 border-l-red-500{% else %}bg-gray-900/40{% endif %} hover:border-gray-700 hover:shadow-lg" data-notification-id="{{ notif.notification_id }}" data-read="{{ 'true' if notif.is_read else 'false' }}">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0 flex-1">
          <div class="flex items-start gap-2">
            <!-- Icon -->
            <div class="flex-shrink-0 mt-1">
              {% if not notif.is_read %}
              <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
              {% else %}
              <i class="fas fa-check-circle text-gray-500 text-xs"></i>
              {% endif %}
            </div>
            <!-- Content -->
            <div class="flex-1 min-w-0">
              <p class="text-white font-semibold text-xs sm:text-sm md:text-base {% if not notif.is_read %}font-bold{% endif %}">{{ notif.message }}</p>
              <div class="flex flex-wrap items-center gap-2 text-xs text-gray-400 mt-2">
                {% if notif.job_title and notif.job_title != 'N/A' %}
                <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-800/50 rounded-md">
                  <i class="fas fa-briefcase text-xs"></i>{{ notif.job_title }}
                </span>
                {% endif %}
                {% if notif.applicant_name and notif.applicant_name != 'Unknown' %}
                <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-800/50 rounded-md">
                  <i class="fas fa-user text-xs"></i>{{ notif.applicant_name }}
                </span>
                {% endif %}
                {% if notif.application_status %}
                <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-800/50 rounded-md">
                  <i class="fas fa-tag text-xs"></i>{{ notif.application_status.replace('_', ' ')|title }}
                </span>
                {% endif %}
                <span class="inline-flex items-center gap-1 text-gray-500">
                  <i class="fas fa-clock text-xs"></i>{{ notif.sent_at }}
                </span>
              </div>
            </div>
          </div>
        </div>
        <!-- Actions -->
        <div class="flex-shrink-0 flex items-center gap-2">
          {% if not notif.is_read %}
          <form class="mark-read-form inline" action="{{ url_for('mark_hr_notification_read', notification_id=notif.notification_id) }}" method="POST" data-notification-id="{{ notif.notification_id }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="text-xs px-2 sm:px-3 py-1 sm:py-1.5 bg-red-600/20 text-red-400 hover:bg-red-600/30 rounded-lg border border-red-600/30 hover:border-red-600/50 transition-all flex items-center gap-1.5" title="Mark as Read">
              <i class="fas fa-check text-xs"></i>
              <span class="hidden sm:inline">Mark Read</span>
            </button>
          </form>
          {% else %}
          <span class="text-xs px-2 sm:px-3 py-1 sm:py-1.5 bg-gray-800/50 text-gray-500 rounded-lg border border-gray-700 flex items-center gap-1.5">
            <i class="fas fa-check-circle text-xs"></i>
            <span class="hidden sm:inline">Read</span>
          </span>
          {% endif %}
          <form class="delete-notification-form inline" action="{{ url_for('delete_hr_notification', notification_id=notif.notification_id) }}" method="POST" data-notification-id="{{ notif.notification_id }}" onsubmit="return confirm('Delete this notification? This cannot be undone.');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="text-xs px-2 sm:px-3 py-1 sm:py-1.5 bg-red-600/20 text-red-400 hover:bg-red-600/30 rounded-lg border border-red-600/30 hover:border-red-600/50 transition-all flex items-center gap-1.5" title="Delete">
              <i class="fas fa-trash text-xs"></i>
              <span class="hidden sm:inline">Delete</span>
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% else %}
<div class="card rounded-2xl bg-gray-900/80 p-8 sm:p-10 text-center text-gray-400 border border-gray-800">
  <i class="fas fa-bell-slash text-4xl sm:text-5xl mb-3 sm:mb-4 text-gray-600"></i>
  <p class="text-base sm:text-lg font-semibold mb-2">No notifications</p>
  <p class="text-xs sm:text-sm">You'll see applicant updates here as they happen.</p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Handle mark all as read
    const markAllReadForm = document.getElementById('mark-all-read-form');
    if (markAllReadForm) {
        markAllReadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalHTML = submitBtn.innerHTML;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Processing...</span>';
                
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update all notification items to read state
                    document.querySelectorAll('.notification-item').forEach(item => {
                        item.classList.remove('bg-gray-800/50', 'border-l-4', 'border-l-red-500');
                        item.classList.add('bg-gray-900/40');
                        item.setAttribute('data-read', 'true');
                        
                        // Update icon
                        const iconDiv = item.querySelector('.flex-shrink-0');
                        if (iconDiv) {
                            iconDiv.innerHTML = '<i class="fas fa-check-circle text-gray-500 text-xs"></i>';
                        }
                        
                        // Update action buttons
                        const markReadForm = item.querySelector('.mark-read-form');
                        if (markReadForm) {
                            markReadForm.outerHTML = '<span class="text-xs px-2 sm:px-3 py-1 sm:py-1.5 bg-gray-800/50 text-gray-500 rounded-lg border border-gray-700 flex items-center gap-1.5"><i class="fas fa-check-circle text-xs"></i><span class="hidden sm:inline">Read</span></span>';
                        }
                    });
                    
                    // Update unread count
                    const unreadCountEl = document.getElementById('unread-count');
                    if (unreadCountEl) {
                        unreadCountEl.textContent = '0';
                    }
                    
                    // Hide mark all as read button
                    if (markAllReadForm) {
                        markAllReadForm.style.display = 'none';
                    }
                    
                    // Show success message
                    showFlashMessage('All notifications marked as read.', 'success');
                } else {
                    showFlashMessage(data.error || 'Failed to mark all notifications as read.', 'error');
                }
            } catch (error) {
                console.error('Error marking all as read:', error);
                showFlashMessage('Failed to mark all notifications as read.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
            }
        });
    }
    
    // Handle individual mark as read
    document.querySelectorAll('.mark-read-form').forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const notificationItem = this.closest('.notification-item');
            const notificationId = this.getAttribute('data-notification-id');
            const submitBtn = this.querySelector('button[type="submit"]');
            
            try {
                submitBtn.disabled = true;
                
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success && notificationItem) {
                    // Update notification item to read state
                    notificationItem.classList.remove('bg-gray-800/50', 'border-l-4', 'border-l-red-500');
                    notificationItem.classList.add('bg-gray-900/40');
                    notificationItem.setAttribute('data-read', 'true');
                    
                    // Update icon
                    const iconDiv = notificationItem.querySelector('.flex-shrink-0');
                    if (iconDiv) {
                        iconDiv.innerHTML = '<i class="fas fa-check-circle text-gray-500 text-xs"></i>';
                    }
                    
                    // Replace mark read button with read indicator
                    this.outerHTML = '<span class="text-xs px-2 sm:px-3 py-1 sm:py-1.5 bg-gray-800/50 text-gray-500 rounded-lg border border-gray-700 flex items-center gap-1.5"><i class="fas fa-check-circle text-xs"></i><span class="hidden sm:inline">Read</span></span>';
                    
                    // Update unread count
                    const unreadCountEl = document.getElementById('unread-count');
                    if (unreadCountEl) {
                        const currentCount = parseInt(unreadCountEl.textContent) || 0;
                        const newCount = Math.max(0, currentCount - 1);
                        unreadCountEl.textContent = newCount;
                        
                        // Hide mark all as read button if no unread notifications
                        if (newCount === 0 && markAllReadForm) {
                            markAllReadForm.style.display = 'none';
                        }
                    }
                } else {
                    showFlashMessage(data.error || 'Failed to mark notification as read.', 'error');
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
                showFlashMessage('Failed to mark notification as read.', 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });
    });
    
    // Handle delete notification
    document.querySelectorAll('.delete-notification-form').forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!confirm('Delete this notification? This cannot be undone.')) {
                return false;
            }
            
            const formData = new FormData(this);
            const notificationItem = this.closest('.notification-item');
            const notificationId = this.getAttribute('data-notification-id');
            const submitBtn = this.querySelector('button[type="submit"]');
            const wasUnread = notificationItem && notificationItem.getAttribute('data-read') === 'false';
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i>';
                
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: formData
                });
                
                // Check if response is OK
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP error! status: ${response.status}`);
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type') || '';
                let data;
                if (contentType.includes('application/json')) {
                    try {
                        data = await response.json();
                    } catch (jsonError) {
                        // If JSON parsing fails, assume success
                        data = { success: true };
                    }
                } else {
                    // If not JSON, assume success and proceed
                    data = { success: true };
                }
                
                if (data.success && notificationItem) {
                    // Show success message (don't display raw JSON)
                    showFlashMessage('Notification deleted successfully.', 'success');
                    
                    // Animate removal
                    notificationItem.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    notificationItem.style.opacity = '0';
                    notificationItem.style.transform = 'translateX(-20px)';
                    
                    setTimeout(() => {
                        notificationItem.remove();
                        
                        // Check if list is empty
                        const notificationsList = document.getElementById('notifications-list');
                        if (notificationsList && notificationsList.children.length === 0) {
                            window.location.reload();
                        }
                    }, 300);
                    
                    // Update unread count if notification was unread
                    if (wasUnread) {
                        const unreadCountEl = document.getElementById('unread-count');
                        if (unreadCountEl) {
                            const currentCount = parseInt(unreadCountEl.textContent) || 0;
                            const newCount = Math.max(0, currentCount - 1);
                            unreadCountEl.textContent = newCount;
                            
                            // Hide mark all as read button if no unread notifications
                            if (newCount === 0 && markAllReadForm) {
                                markAllReadForm.style.display = 'none';
                            }
                        }
                    }
                } else {
                    showFlashMessage(data.error || data.message || 'Failed to delete notification.', 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-trash text-xs"></i> <span class="hidden sm:inline">Delete</span>';
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
                // Check if error response contains JSON
                if (error.response) {
                    try {
                        const errorData = await error.response.json();
                        showFlashMessage(errorData.error || errorData.message || 'Failed to delete notification.', 'error');
                    } catch {
                        showFlashMessage('Failed to delete notification.', 'error');
                    }
                } else {
                    showFlashMessage('Failed to delete notification.', 'error');
                }
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-trash text-xs"></i> <span class="hidden sm:inline">Delete</span>';
            }
        });
    });
    
    // Handle delete all notifications
    const deleteAllForm = document.getElementById('delete-all-form');
    if (deleteAllForm) {
        deleteAllForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!confirm('Delete all notifications? This cannot be undone.')) {
                return false;
            }
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalHTML = submitBtn.innerHTML;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Deleting...</span>';
                
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: formData
                });
                
                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type') || '';
                let data;
                if (contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    // If not JSON, assume success and proceed
                    data = { success: true };
                }
                
                if (data.success) {
                    // Show success message before reload
                    showFlashMessage('All notifications deleted successfully.', 'success');
                    // Reload page after a brief delay to show the message
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showFlashMessage(data.error || data.message || 'Failed to delete all notifications.', 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                }
            } catch (error) {
                console.error('Error deleting all notifications:', error);
                // Don't display raw error or JSON - show user-friendly message
                showFlashMessage('Failed to delete all notifications. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
            }
        });
    }
    
    // Helper function to show flash messages
    function showFlashMessage(message, type) {
        const flashContainer = document.createElement('div');
        flashContainer.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 ${
            type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
        }`;
        flashContainer.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(flashContainer);
        
        setTimeout(() => {
            flashContainer.style.transition = 'opacity 0.3s ease';
            flashContainer.style.opacity = '0';
            setTimeout(() => flashContainer.remove(), 300);
        }, 3000);
    }
});
</script>
{% endblock %}


