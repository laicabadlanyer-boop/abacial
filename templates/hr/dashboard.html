{% extends "hr/_base.html" %}

{% block title %}HR Dashboard  J&T Express{% endblock %}

{% block extra_css %}
<style>
    body {
        background: #0a0a0a;
        color: #ffffff;
    }
    .hr-red {
        color: #dc2626;
    }
    .bg-hr-red {
        background-color: #dc2626;
    }
    .bg-hr-dark {
        background-color: #111827;
    }
    .bg-hr-light {
        background-color: #0a0a0a;
    }
    .branch-card {
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .branch-card:hover {
        transform: translateY(-2px);
        border-color: #dc2626;
        box-shadow: 0 12px 40px rgba(220, 38, 38, 0.3);
    }
    .stat-card {
        background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-left: 4px solid #dc2626;
    }
    .table-card {
        background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }
</style>
{% endblock %}

{% block content %}
{% set dd = dashboard_data or {} %}
{% set user = dd.user or {} %}
{% set stats = dd.stats or {} %}
{% set branch_stats = dd.branch_stats or [] %}
{% set recent_jobs = dd.recent_jobs_with_branch or dd.recent_jobs or [] %}
{% set recent_applicants = dd.recent_applicants_with_branch or dd.recent_applications or [] %}

<!-- Main Content -->
<div class="flex-1 overflow-auto bg-hr-light">
    <!-- Top Bar -->
    <header class="bg-black border-b-2 border-red-600/50 shadow-lg p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div class="flex items-center gap-3">
        <h2 class="text-2xl font-bold text-white">HR Dashboard</h2>
        </div>
    </header>

    <!-- Branch Selector -->
    <div class="p-6 bg-gradient-to-r from-black via-gray-900 to-black border-b-2 border-red-600/30">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-red-600/20 rounded-lg border border-red-600/30">
                    <i class="fas fa-code-branch text-hr-red text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white">Branch Filter</h3>
                    <p class="text-sm text-gray-400">Select a branch to view branch-specific data</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <label for="branch-select" class="text-sm font-medium text-gray-300 hidden md:block">
                    Filter by Branch:
                </label>
                <select id="branch-select" name="branch_id" 
                        class="px-4 py-2.5 bg-gray-900 border-2 border-gray-800 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600 min-w-[200px] transition-all hover:border-red-600/50">
                    <option value="all" {% if not dd.selected_branch_id %}selected{% endif %}>All Branches</option>
                    {% for branch in dd.all_branches or [] %}
                    <option value="{{ branch.branch_id }}" {% if dd.selected_branch_id == branch.branch_id %}selected{% endif %}>
                        {{ branch.branch_name }}
                    </option>
                    {% endfor %}
                </select>
                {% if dd.selected_branch_id %}
                <a href="{{ url_for('hr_dashboard') }}" class="px-4 py-2.5 bg-gray-800 hover:bg-gray-700 text-white rounded-lg border border-gray-700 transition-colors text-sm font-medium flex items-center gap-2">
                    <i class="fas fa-times"></i>
                    Clear
                </a>
                {% endif %}
            </div>
        </div>
        {% if dd.selected_branch_id and dd.branch_info %}
        <div class="mt-4 pt-4 border-t border-gray-800">
            <div class="flex items-center gap-2 text-sm">
                <span class="text-gray-400">Viewing:</span>
                <span class="px-3 py-1 bg-red-600/20 text-red-300 border border-red-600/40 rounded-full font-medium">
                    <i class="fas fa-building mr-2"></i>{{ dd.branch_info.branch_name }}
                </span>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Branch Overview Cards -->
    <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="branch-cards">
        {% for branch_stat in branch_stats %}
        <div class="rounded-xl shadow-lg p-6 branch-card transition-all {% if dd.selected_branch_id and dd.selected_branch_id != branch_stat.branch_id %}opacity-50{% endif %}" 
             data-branch-id="{{ branch_stat.branch_id }}"
             {% if dd.selected_branch_id and dd.selected_branch_id != branch_stat.branch_id %}style="display: none;"{% endif %}>
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-800">
                <h3 class="text-lg font-bold text-white">{{ branch_stat.branch_name or 'Unassigned' }}</h3>
                <span class="px-2 py-1 bg-green-600/20 text-green-400 border border-green-600/30 text-xs rounded-full">Active</span>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-hr-red">{{ branch_stat.open_jobs or 0 }}</div>
                    <div class="text-gray-400 text-sm">Open Job Positions</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-hr-red">{{ branch_stat.applicants or 0 }}</div>
                    <div class="text-gray-400 text-sm">Applicants</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-hr-red">{{ branch_stat.interviews_today or 0 }}</div>
                    <div class="text-gray-400 text-sm">Interviews</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-hr-red">{{ branch_stat.hires or 0 }}</div>
                    <div class="text-gray-400 text-sm">Hires This Month</div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-span-full rounded-xl shadow-lg border border-gray-800 p-6 text-center text-gray-500 bg-gray-900/50">
            <i class="fas fa-building text-4xl mb-3 text-gray-600"></i>
            <p>No branch data available</p>
        </div>
        {% endfor %}
    </div>

    <!-- Job Postings & Recent Applicants -->
    <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Job Postings -->
        <div class="table-card rounded-xl shadow-lg">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                <h3 class="font-bold text-lg text-white">Job Postings - All Branches</h3>
            </div>
            <div class="p-4 overflow-x-auto">
                <table class="w-full min-w-[600px]">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-gray-800">
                            <th class="pb-3 font-semibold">Job Title</th>
                            <th class="pb-3 font-semibold">Branch</th>
                            <th class="pb-3 font-semibold">Applications</th>
                            <th class="pb-3 font-semibold">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in recent_jobs[:5] %}
                        <tr class="border-b border-gray-800 hover:bg-gray-900/50 transition-colors">
                            <td class="py-3 text-white">{{ job.job_title or job.title or 'Untitled Job' }}</td>
                            <td class="py-3 text-gray-400">{{ job.branch_name or 'Unassigned' }}</td>
                            <td class="py-3 text-white">{{ job.application_count or 0 }}</td>
                            <td class="py-3">
                                {% set job_status = (job.status or 'open')|lower %}
                                {% if job_status in ['open', 'published', 'active'] %}
                                <span class="px-2 py-1 bg-green-600/20 text-green-400 border border-green-600/30 rounded-full text-xs">Open</span>
                                {% else %}
                                <span class="px-2 py-1 bg-red-600/20 text-red-400 border border-red-600/30 rounded-full text-xs">Closed</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="py-8 text-center text-gray-500">
                                <i class="fas fa-briefcase text-2xl mb-2 text-gray-600"></i>
                                <p>No job postings found</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Applicants -->
        <div class="table-card rounded-xl shadow-lg">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                <h3 class="font-bold text-lg text-white">Recent Applicants - All Branches</h3>
                <a href="{{ url_for('applicants') }}" class="text-hr-red hover:text-red-400 text-sm font-medium">
                    <i class="fas fa-filter mr-2"></i>View All
                </a>
            </div>
            <div class="p-4 overflow-x-auto">
                <table class="w-full min-w-[600px]">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-gray-800">
                            <th class="pb-3 font-semibold">Name</th>
                            <th class="pb-3 font-semibold">Job Position</th>
                            <th class="pb-3 font-semibold">Branch</th>
                            <th class="pb-3 font-semibold">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for applicant in recent_applicants[:5] %}
                        <tr class="border-b border-gray-800 hover:bg-gray-900/50 transition-colors">
                            <td class="py-3 text-white">{{ applicant.applicant_name or applicant.full_name or 'Unknown' }}</td>
                            <td class="py-3 text-gray-400">{{ applicant.job_title or 'N/A' }}</td>
                            <td class="py-3 text-gray-400">{{ applicant.branch_name or 'Unassigned' }}</td>
                            <td class="py-3">
                                {% set app_status = (applicant.status or 'pending')|lower %}
                                {% set status_config = {
                                    'pending': {'class': 'bg-yellow-600/20 text-yellow-400 border-yellow-600/30', 'label': 'Pending'},
                                    'interviewed': {'class': 'bg-cyan-600/20 text-cyan-400 border-cyan-600/30', 'label': 'Interviewed'},
                                    'hired': {'class': 'bg-green-600/20 text-green-400 border-green-600/30', 'label': 'Hired'},
                                    'rejected': {'class': 'bg-red-600/20 text-red-400 border-red-600/30', 'label': 'Rejected'},
                                    'reviewed': {'class': 'bg-yellow-600/20 text-yellow-400 border-yellow-600/30', 'label': 'Pending'},
                                    'shortlisted': {'class': 'bg-yellow-600/20 text-yellow-400 border-yellow-600/30', 'label': 'Pending'},
                                    'accepted': {'class': 'bg-green-600/20 text-green-400 border-green-600/30', 'label': 'Hired'},
                                    'applied': {'class': 'bg-yellow-600/20 text-yellow-400 border-yellow-600/30', 'label': 'Pending'},
                                    'under_review': {'class': 'bg-yellow-600/20 text-yellow-400 border-yellow-600/30', 'label': 'Pending'},
                                    'interview': {'class': 'bg-cyan-600/20 text-cyan-400 border-cyan-600/30', 'label': 'Interviewed'}
                                } %}
                                {% set current_status = status_config.get(app_status, {'class': 'bg-gray-600/20 text-gray-400 border-gray-600/30', 'label': app_status|title}) %}
                                <span class="px-2 py-1 rounded-full text-xs border {{ current_status.class }}">
                                    {{ current_status.label }}
                                </span>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="py-8 text-center text-gray-500">
                                <i class="fas fa-users text-2xl mb-2 text-gray-600"></i>
                                <p>No applicants found</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Branch selector functionality
        const branchSelect = document.getElementById('branch-select');
        if (branchSelect) {
            branchSelect.addEventListener('change', function() {
                const selectedBranch = this.value;
                if (selectedBranch === 'all') {
                    // Reload page to show all data
                    window.location.href = '{{ url_for("hr_dashboard") }}';
                } else {
                    // Reload page with branch filter
                    window.location.href = '{{ url_for("hr_dashboard") }}?branch_id=' + selectedBranch;
                }
            });
        }
        
        // Delete job functionality removed - jobs can only be closed, not deleted
    });
</script>
{% endblock %}
