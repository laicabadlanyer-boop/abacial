{% extends "applicant/_base.html" %}

{% block title %}Apply • Applicant{% endblock %}

{% block extra_css %}
<style>
    .form-input {
        width: 100%;
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(15, 23, 42, 0.65);
        padding: 0.9rem 1.1rem;
        color: #e2e8f0;
    }
    .form-input:focus {
        outline: none;
        border-color: rgba(248, 113, 113, 0.6);
        box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.1);
    }
    .resume-option {
        border-radius: 1.25rem;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(15, 23, 42, 0.5);
        padding: 1rem;
        cursor: pointer;
        transition: border-color 0.2s ease;
    }
    .resume-option input:checked + div {
        border-color: rgba(248, 113, 113, 0.5);
        background: rgba(248, 113, 113, 0.05);
    }
</style>
{% endblock %}

{% block content %}
{% set job = job or None %}
{% set jobs = jobs or [] %}
{% set resumes = resumes or [] %}
<section class="space-y-6">
    <header class="glass-panel rounded-3xl p-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
            <p class="text-xs uppercase tracking-[0.4em] text-slate-400">{{ 'Update application' if edit_application_id else 'New application' }}</p>
            <h1 class="text-3xl font-semibold text-white">
                {{ job.job_title if job else 'Select a job' }}
            </h1>
            {% if job %}
            <p class="text-slate-400 text-sm mt-2">{{ job.branch_name }}</p>
            {% endif %}
        </div>
        <a href="{{ url_for('jobs') }}" class="px-5 py-3 rounded-2xl border border-white/20 text-sm font-semibold text-white/80 hover:text-white">
            <i class="fas fa-arrow-left mr-2"></i>Back to jobs
        </a>
    </header>

    <section class="glass-panel rounded-3xl p-6 border border-white/10 space-y-6">
        <form id="apply-form" method="post" action="{{ url_for('apply_to_job', job_id=job.job_id if job else None) }}" enctype="multipart/form-data" class="space-y-5">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% if edit_application_id %}
            <input type="hidden" name="edit_application_id" value="{{ edit_application_id }}">
            {% endif %}
            {% if edit_application_id or job %}
            {# When editing OR when job_id is provided (clicked Apply Now), show job as read-only #}
            <div>
                <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Job Position</p>
                <div class="mt-2 p-3 rounded-xl bg-slate-800/50 border border-slate-700/50 text-white" role="group" aria-labelledby="job-position-label">
                    <p id="job-position-label" class="font-semibold">{{ job.job_title if job else 'N/A' }}</p>
                    <p class="text-xs text-slate-400 mt-1">{{ job.branch_name if job else '' }}</p>
                </div>
                <input type="hidden" name="job_id" value="{{ job.job_id if job else '' }}">
            </div>
            {% else %}
            {# When no job_id provided (accessing /applicant/apply directly), show job selector #}
            <div>
                <label for="job-select" class="text-xs uppercase tracking-[0.3em] text-slate-500">Select job</label>
                <select id="job-select" name="job_id" class="form-input mt-2" required>
                    <option value="">Choose a job position</option>
                    {% for option in jobs %}
                    <option value="{{ option.job_id }}">
                        {{ option.job_title }} • {{ option.branch_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="space-y-4">
                <div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-3">
                        <div>
                            <p class="text-sm text-slate-400 mb-2">Upload resume</p>
                            <div class="space-y-3">
                                <input id="resume-file" type="file" name="resume_file" accept=".pdf,application/pdf" class="form-input">
                                <p class="text-xs text-slate-500">PDF format only. Maximum file size: 5MB.</p>
                                <p id="file-error" class="text-xs text-red-400 mt-2 hidden"></p>
                                <p id="upload-success" class="text-xs text-green-400 mt-2 hidden"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit" class="w-full px-6 py-3 rounded-2xl bg-rose-500/80 hover:bg-rose-500 text-white text-sm font-semibold">
                {{ 'Update application' if edit_application_id else 'Submit application' }}
            </button>
        </form>
    </section>

    {% if job %}
    <section class="glass-panel rounded-3xl p-6 border border-white/10 space-y-4">
        <p class="text-white font-semibold mb-2">Descriptions</p>
        <p class="text-slate-300 text-sm whitespace-pre-line">{{ job.job_description or 'No description provided.' }}</p>
        {% if job.job_requirements %}
        <div>
            <p class="text-white font-semibold mb-2">Requirements</p>
            <p class="text-slate-300 text-sm whitespace-pre-line">{{ job.job_requirements }}</p>
        </div>
        {% endif %}
    </section>
    {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('apply-form');
    const fileInput = document.getElementById('resume-file');
    const fileError = document.getElementById('file-error');
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB in bytes
    
    if (!form) return;
    
    // File validation on change
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            fileError.classList.add('hidden');
            fileError.textContent = '';
            
            if (file) {
                // Check file type
                const fileName = file.name.toLowerCase();
                const isValidType = fileName.endsWith('.pdf') || file.type === 'application/pdf';
                
                if (!isValidType) {
                    fileError.textContent = 'Unsupported file type. Please upload a PDF file.';
                    fileError.classList.remove('hidden');
                    fileInput.value = ''; // Clear the file input
                    return false;
                }
                
                // Check file size
                if (file.size > MAX_FILE_SIZE) {
                    fileError.textContent = 'File size exceeds the 5MB limit. Please upload a smaller file.';
                    fileError.classList.remove('hidden');
                    fileInput.value = ''; // Clear the file input
                    return false;
                }
                
                // Show file size info
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                fileError.textContent = `File selected: ${file.name} (${fileSizeMB} MB)`;
                fileError.classList.remove('hidden');
                fileError.classList.remove('text-red-400');
                fileError.classList.add('text-green-400');
            }
        });
    }
    
    // Upload resume before submitting application
    const uploadResumeBtn = document.getElementById('upload-resume-btn');
    const uploadSuccess = document.getElementById('upload-success');
    const resumeList = document.getElementById('resume-list');
    
    if (uploadResumeBtn && fileInput) {
        uploadResumeBtn.addEventListener('click', function() {
            if (!fileInput.files || fileInput.files.length === 0) {
                fileError.textContent = 'Please select a file first.';
                fileError.classList.remove('hidden');
                fileError.classList.remove('text-green-400');
                fileError.classList.add('text-red-400');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validate file
            const fileName = file.name.toLowerCase();
            const isValidType = fileName.endsWith('.pdf') || file.type === 'application/pdf';
            
            if (!isValidType) {
                fileError.textContent = 'Unsupported file type. Please upload a PDF file.';
                fileError.classList.remove('hidden');
                fileError.classList.remove('text-green-400');
                fileError.classList.add('text-red-400');
                return;
            }
            
            if (file.size > MAX_FILE_SIZE) {
                fileError.textContent = 'File size exceeds the 5MB limit. Please upload a smaller file.';
                fileError.classList.remove('hidden');
                fileError.classList.remove('text-green-400');
                fileError.classList.add('text-red-400');
                return;
            }
            
            // Upload resume
            const formData = new FormData();
            formData.append('resume_file', file);
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
            
            uploadResumeBtn.disabled = true;
            uploadResumeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
            
            fetch('{{ url_for("upload_resume_before_apply") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadSuccess.textContent = `✓ Resume uploaded successfully! You can now select it above or submit your application.`;
                    uploadSuccess.classList.remove('hidden');
                    fileError.classList.add('hidden');
                    
                    // Reload page to show new resume in list
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    fileError.textContent = data.error || 'Failed to upload resume.';
                    fileError.classList.remove('hidden');
                    fileError.classList.remove('text-green-400');
                    fileError.classList.add('text-red-400');
                    uploadResumeBtn.disabled = false;
                    uploadResumeBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload Resume First';
                }
            })
            .catch(error => {
                fileError.textContent = 'Error uploading resume. Please try again.';
                fileError.classList.remove('hidden');
                fileError.classList.remove('text-green-400');
                fileError.classList.add('text-red-400');
                uploadResumeBtn.disabled = false;
                uploadResumeBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload Resume First';
            });
        });
    }
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        if (fileInput && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            
            // Check file type
            const fileName = file.name.toLowerCase();
            const isValidType = fileName.endsWith('.pdf') || file.type === 'application/pdf';
            
            if (!isValidType) {
                e.preventDefault();
                fileError.textContent = 'Unsupported file type. Please upload a PDF file.';
                fileError.classList.remove('hidden');
                fileError.classList.remove('text-green-400');
                fileError.classList.add('text-red-400');
                fileInput.focus();
                return false;
            }
            
            // Check file size
            if (file.size > MAX_FILE_SIZE) {
                e.preventDefault();
                fileError.textContent = 'File size exceeds the 5MB limit. Please upload a smaller file.';
                fileError.classList.remove('hidden');
                fileError.classList.remove('text-green-400');
                fileError.classList.add('text-red-400');
                fileInput.focus();
                return false;
            }
        }
        
        try {
            let jobTitle = '';
            // Try to get job title from dropdown (if exists)
            const select = document.getElementById('job-select');
            if (select) {
                const opt = select.options[select.selectedIndex];
                jobTitle = opt ? opt.textContent.trim() : '';
            } else {
                // If no dropdown, get job title from the read-only display
                const jobDisplay = document.querySelector('.bg-slate-800\\/50 p.font-semibold');
                if (jobDisplay) {
                    jobTitle = jobDisplay.textContent.trim();
                }
            }
            sessionStorage.setItem('wh88_notify_application', JSON.stringify({
                jobTitle,
                ts: Date.now()
            }));
        } catch(e) {}
    });
});
</script>
{% endblock %}

