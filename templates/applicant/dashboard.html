{% extends "applicant/_base.html" %}

{% block title %}Dashboard • Applicant{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border-radius: 1.25rem;
        padding: 1.25rem;
        background: radial-gradient(circle at top, rgba(248, 113, 113, 0.15), rgba(15, 23, 42, 0.85));
        border: 1px solid rgba(248, 113, 113, 0.2);
        box-shadow: 0 15px 35px rgba(2, 6, 23, 0.45);
        min-height: 140px;
    }
    .timeline::before {
        content: "";
        position: absolute;
        inset: 0 0 0 18px;
        width: 2px;
        background: linear-gradient(180deg, rgba(248, 113, 113, 0.6), transparent);
    }
    .timeline-item {
        position: relative;
        padding-left: 3.5rem;
    }
    .timeline-item::before {
        content: "";
        position: absolute;
        left: 12px;
        top: 0.35rem;
        width: 12px;
        height: 12px;
        border-radius: 999px;
        background: #f87171;
        box-shadow: 0 0 0 6px rgba(248, 113, 113, 0.15);
    }
    .card-hover {
        transition: transform 0.25s ease, border-color 0.25s ease;
    }
    .card-hover:hover {
        transform: translateY(-4px);
        border-color: rgba(148, 163, 184, 0.4);
    }
</style>
{% endblock %}

{% block content %}
{% set stats = stats or {} %}
{% set recent_applications = recent_applications or [] %}
{% set upcoming_interviews = upcoming_interviews or [] %}
{% set recent_activity = recent_activity or [] %}
<section class="grid gap-6">
    <header class="glass-panel rounded-3xl p-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
            <div>
                <p class="text-sm uppercase tracking-[0.4em] text-slate-400 mb-2">Welcome back</p>
                <h1 class="text-3xl sm:text-4xl font-semibold text-white">
                    {{ applicant.name if applicant else session.get('user_name') or 'Applicant' }}
                </h1>
                <p class="text-slate-400 mt-2 text-sm sm:text-base">
                    Track your applications, interviews, and communications in one place.
                </p>
            </div>
            <div class="flex flex-wrap gap-3">
                <a href="{{ url_for('jobs') }}" class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl bg-rose-500/80 hover:bg-rose-500 text-white font-semibold text-sm shadow-lg shadow-rose-500/30 transition">
                    <i class="fas fa-briefcase"></i> Discover Jobs
                </a>
                <a href="{{ url_for('applicant_applications') }}" class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl border border-white/20 text-white/80 hover:text-white hover:border-white/40 transition text-sm font-semibold">
                    <i class="fas fa-list-check"></i> View Applications
                </a>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
        {% set metric_config = [
            {'label': 'Applications', 'value': stats.total_applications or 0, 'color': 'from-rose-500/60 to-rose-500/20', 'modal': None},
            {'label': 'Pending', 'value': stats.pending or 0, 'color': 'from-amber-400/60 to-amber-400/10', 'modal': None},
            {'label': 'Interviewed', 'value': stats.interviewed or 0, 'color': 'from-sky-400/60 to-sky-400/10', 'modal': None},
            {'label': 'Rejected', 'value': stats.rejected or 0, 'color': 'from-rose-600/60 to-rose-600/20', 'modal': 'rejectedModal'}
        ] %}
        {% for metric in metric_config %}
        <article class="stat-card bg-gradient-to-br {{ metric.color }} border border-white/5 {% if metric.modal %}cursor-pointer hover:opacity-90 transition-opacity{% endif %}" {% if metric.modal %}onclick="openModal('{{ metric.modal }}')"{% endif %}>
            <div class="mb-6">
                <p class="text-sm uppercase tracking-[0.3em] text-white/70">{{ metric.label }}</p>
            </div>
            <p class="text-4xl font-bold text-white">{{ metric.value or 0 }}</p>
        </article>
        {% endfor %}
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <section class="glass-panel rounded-3xl p-6 space-y-5 card-hover border border-white/5">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-white">Recent Applications</h2>
                    <p class="text-slate-400 text-sm">Latest updates on your submissions</p>
                </div>
                <a href="{{ url_for('applicant_applications') }}" class="text-xs font-semibold text-white/70 hover:text-white transition">See all</a>
            </div>
            {% if recent_applications %}
            <div class="space-y-4">
                {% for application in recent_applications %}
                {% set status_map = {
                    'pending': {'label': 'Pending', 'classes': 'bg-amber-500/10 text-amber-200 border border-amber-500/30'},
                    'scheduled': {'label': 'Scheduled', 'classes': 'bg-purple-500/10 text-purple-200 border border-purple-500/30'},
                    'reviewed': {'label': 'Reviewed', 'classes': 'bg-sky-500/10 text-sky-200 border border-sky-500/30'},
                    'interviewed': {'label': 'Interviewing', 'classes': 'bg-cyan-500/10 text-cyan-200 border border-cyan-500/30'},
                    'accepted': {'label': 'Offer', 'classes': 'bg-emerald-500/10 text-emerald-200 border border-emerald-500/30'},
                    'hired': {'label': 'Hired', 'classes': 'bg-emerald-500/10 text-emerald-200 border border-emerald-500/30'},
                    'rejected': {'label': 'Rejected', 'classes': 'bg-rose-500/10 text-rose-200 border border-rose-500/30'}
                } %}
                {% set app_status = (application.status or 'pending')|lower %}
                {% if app_status == 'accepted' %}
                    {% set app_status = 'hired' %}
                {% elif app_status in ['reviewed', 'applied', 'under_review'] %}
                    {% set app_status = 'pending' %}
                {% elif app_status == 'interview' %}
                    {# Don't auto-change to interviewed - respect actual status (scheduled/interviewed) #}
                    {# Status flow: pending -> scheduled (when interview scheduled) -> interviewed (when interview completed) #}
                {% endif %}
                {% set status = status_map.get(app_status, {'label': (application.status or 'Pending')|title, 'classes': 'bg-slate-500/10 text-slate-200 border border-slate-500/30'}) %}
                <article class="rounded-2xl border border-white/10 bg-white/[0.02] p-4 flex flex-col gap-3">
                    <div class="flex flex-wrap items-center justify-between gap-3">
                        <div>
                            <p class="text-white font-semibold">{{ application.job_title or 'Untitled Job' }}</p>
                            {% set branch = (application.branch_name or application.company_name or '')|trim %}
                            {% if branch and branch|lower not in ['unassigned', 'unassigned branch'] %}
                            <p class="text-xs text-slate-400">{{ branch }}</p>
                            {% endif %}
                        </div>
                        <span class="px-3 py-1.5 rounded-full text-xs font-semibold border {{ status.classes }}">{{ status.label }}</span>
                    </div>
                    <div class="flex flex-wrap items-center gap-4 text-xs text-slate-400">
                        <span><i class="fas fa-calendar mr-2 text-slate-500"></i>{{ application.applied_date }}</span>
                        {% set loc = (application.location or '')|trim %}
                        {% if loc and loc|lower not in ['unassigned', 'unassigned branch'] %}
                        <span><i class="fas fa-map-marker-alt mr-2 text-slate-500"></i>{{ loc }}</span>
                        {% endif %}
                        {% if application.has_interview %}
                        <span class="text-emerald-300 font-semibold flex items-center gap-2">
                            <i class="fas fa-video"></i> Interview scheduled
                        </span>
                        {% endif %}
                    </div>
                </article>
                {% endfor %}
            </div>
            {% else %}
            <div class="border border-dashed border-white/15 rounded-2xl py-8 text-center">
                <p class="text-slate-400 text-sm mb-3">No applications yet</p>
                <a href="{{ url_for('jobs') }}" class="text-white text-sm font-semibold hover:underline">Start applying</a>
            </div>
            {% endif %}
        </section>

        <section class="glass-panel rounded-3xl p-6 space-y-5 card-hover border border-white/5">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-white">Upcoming Interviews</h2>
                    <p class="text-slate-400 text-sm">Stay on top of your schedule</p>
                </div>
                <a href="{{ url_for('applicant_interviews') }}" class="text-xs font-semibold text-white/70 hover:text-white transition">Manage</a>
            </div>
            {% if upcoming_interviews %}
            <div class="space-y-4">
                {% for interview in upcoming_interviews %}
                <article class="rounded-2xl border border-white/10 bg-white/[0.02] p-4 flex flex-col gap-3">
                    <div class="flex justify-between items-start gap-3">
                        <div>
                            <p class="text-white font-semibold">{{ interview.job_title }}</p>
                            <p class="text-xs text-slate-400">{{ interview.company_name }}</p>
                        </div>
                        <span class="status-pill bg-emerald-500/10 text-emerald-200 border border-emerald-500/30">
                            <i class="fas {{ 'fa-video' if interview.is_online else 'fa-building' }} mr-1"></i>
                            {{ 'Online' if interview.is_online else 'On-site' }}
                        </span>
                    </div>
                    <div class="flex flex-wrap items-center gap-4 text-xs text-slate-400">
                        <span><i class="fas fa-calendar mr-2 text-slate-500"></i>{{ interview.date }}</span>
                        {% if interview.location %}
                        <span><i class="fas fa-map-pin mr-2 text-slate-500"></i>{{ interview.location }}</span>
                        {% endif %}
                    </div>
                </article>
                {% endfor %}
            </div>
            {% else %}
            <div class="border border-dashed border-white/15 rounded-2xl py-8 text-center">
                <p class="text-slate-400 text-sm mb-1">No interviews scheduled</p>
                <p class="text-xs text-slate-500">We'll notify you when HR books one.</p>
            </div>
            {% endif %}
        </section>
    </div>

    <section class="glass-panel rounded-3xl p-6 card-hover border border-white/5">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-xl font-semibold text-white">Recent Activity</h2>
                <p class="text-slate-400 text-sm">Everything that changed recently</p>
            </div>
            <a href="{{ url_for('applicant_notifications') }}" class="text-xs font-semibold text-white/70 hover:text-white transition">Notification Center</a>
        </div>
        {% if recent_activity %}
        <div class="relative timeline space-y-6">
            {% for item in recent_activity %}
            <article class="timeline-item">
                <div class="flex flex-wrap items-center justify-between gap-2">
                    <div>
                        <p class="text-white font-medium">{{ item.description }}</p>
                        <p class="text-xs text-slate-400">{{ item.timestamp }}</p>
                    </div>
                    <span class="status-pill bg-white/5 text-white/70 border border-white/10 text-xs">{{ item.type|replace('_',' ')|title }}</span>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <div class="border border-dashed border-white/15 rounded-2xl py-8 text-center text-slate-400 text-sm">
            Nothing to report yet—your activity will appear here.
        </div>
        {% endif %}
    </section>
</section>

<!-- Rejected Applications Modal -->
<div id="rejectedModal" class="modal-overlay hidden" onclick="closeModal('rejectedModal', event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between p-6 border-b border-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-2xl bg-rose-500/20 flex items-center justify-center text-rose-200">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-white">Rejected Applications</h2>
                    <p class="text-xs text-slate-400 mt-1">Total: {{ stats.rejected or 0 }}</p>
                </div>
            </div>
            <button onclick="closeModal('rejectedModal')" class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700/50 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[60vh] custom-scrollbar">
            {% if rejected_applications %}
            <div class="space-y-3">
                {% for application in rejected_applications %}
                <article class="rounded-2xl border border-rose-500/20 bg-rose-500/5 p-4">
                    <div class="flex flex-col gap-2">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex-1 min-w-0">
                                <p class="text-white font-semibold truncate">{{ application.job_title }}</p>
                                <p class="text-xs text-slate-400 mt-1">{{ application.branch_name }}</p>
                            </div>
                            <span class="px-3 py-1.5 rounded-full text-xs font-semibold bg-rose-500/10 text-rose-200 border border-rose-500/30 whitespace-nowrap">
                                Rejected
                            </span>
                        </div>
                        <div class="flex items-center gap-4 text-xs text-slate-400">
                            <span><i class="fas fa-calendar mr-2 text-slate-500"></i>Applied {{ application.submitted_at }}</span>
                        </div>
                    </div>
                </article>
                {% endfor %}
            </div>
            {% else %}
            <div class="border border-dashed border-white/15 rounded-2xl py-8 text-center">
                <i class="fas fa-check-circle text-4xl mb-3 text-slate-500"></i>
                <p class="text-slate-400 text-sm">No rejected applications</p>
                <p class="text-xs text-slate-500 mt-1">Keep applying to find your next opportunity!</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('modal-open');
    }
}

function closeModal(modalId, event) {
    if (event && event.target !== event.currentTarget) {
        return;
    }
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('modal-open');
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal('rejectedModal');
    }
});
</script>
{% endblock %}

