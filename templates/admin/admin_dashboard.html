{% extends "admin/_base.html" %}

{% block title %}Dashboard • J&T Express{% endblock %}

{% set user = dashboard_data.user or {} %}
{% set stats = dashboard_data.stats or {} %}
{% set trends = dashboard_data.trends or {} %}
{% set alerts = dashboard_data.system_alerts or [] %}
{% set active_sessions = dashboard_data.active_sessions or [] %}
{% set recent_activity = dashboard_data.recent_activity or [] %}
{% set recent_apps = dashboard_data.recent_applications or [] %}
{% set interviews = dashboard_data.upcoming_interviews or [] %}

{% block extra_css %}
<style>
    .sidebar-item.active { border-color: #dc2626; background: rgba(220,38,38,.12); }
    .trend-up { color: #10b981; }
    .trend-down { color: #ef4444; }
    .trend-neutral { color: #6b7280; }
    .metric-card { transition: all 0.3s ease; cursor: pointer; }
    .metric-card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(220,38,38,0.3); }
    .progress-bar { height: 8px; background: #1f2937; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #dc2626, #ef4444); transition: width 0.3s ease; }
    .activity-item { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .card { backdrop-filter: blur(10px); }
    .stat-card { transition: all 0.2s ease; }
    .stat-card:hover { transform: scale(1.02); }
</style>
{% endblock %}

{% block content %}

<!-- Helper macros for progress calculation -->
{% macro calculate_progress(value, max_value) %}
    {% set percentage = (value / max_value * 100) if max_value > 0 else 0 %}
    {{ percentage if percentage <= 100 else 100 }}
{% endmacro %}

<header class="card rounded-xl bg-gradient-to-r from-gray-900 via-gray-900 to-black p-3 sm:p-4 md:p-5 flex flex-col md:flex-row md:items-center md:justify-between gap-2 sm:gap-3 border border-gray-800">
    <div class="min-w-0 flex-1">
        <h1 class="text-xl sm:text-2xl md:text-3xl font-bold mb-2 bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">
            Welcome back{{ ', ' + (user.full_name or '') if user and user.full_name else '' }}!
        </h1>
        <p class="text-gray-400 text-xs sm:text-sm md:text-base">Here is the current state of recruitment across J&T Express.</p>
    </div>
</header>

<!-- System Alerts -->
{% if alerts %}
<section class="content-section card rounded-xl bg-gray-900/80 p-3 sm:p-4 border border-gray-800">
    <h2 class="text-sm sm:text-base font-semibold mb-3 flex items-center gap-2">
        <i class="fas fa-bell text-red-400"></i>
        System Alerts
    </h2>
    <div class="space-y-3">
        {% for alert in alerts %}
        <div class="border rounded-xl p-4 flex items-center justify-between transition-all hover:shadow-lg {{
            'border-yellow-600/40 bg-yellow-900/20 hover:bg-yellow-900/30' if alert.type == 'warning' else (
            'border-blue-600/40 bg-blue-900/20 hover:bg-blue-900/30' if alert.type == 'info' else 'border-green-600/40 bg-green-900/20 hover:bg-green-900/30')
        }}">
            <div class="flex items-center gap-3">
                <span class="text-2xl">{{ alert.icon }}</span>
                <div>
                    <p class="font-semibold text-white">{{ alert.message }}</p>
                </div>
            </div>
            <a href="{{ alert.action }}" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 transition-all font-semibold text-sm shadow-lg shadow-red-600/30">View</a>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Key Metrics with Trends -->
<section class="content-section grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 sm:gap-3">
    <div class="metric-card card rounded-xl bg-gray-900/80 p-4 sm:p-5 border border-gray-800 hover:border-red-600/50" onclick="window.location.href='{{ url_for('job_postings') }}'">
        <div class="flex items-center justify-between mb-2">
            <p class="text-xs text-gray-400 uppercase tracking-wide font-semibold">Open Jobs</p>
            <i class="fas fa-briefcase text-red-400 text-lg"></i>
        </div>
        <div class="flex items-end justify-between">
            <p class="text-3xl font-bold text-white">{{ stats.open_jobs or 0 }}</p>
            {% if stats.new_jobs_this_week %}
            <span class="text-xs text-green-400 flex items-center gap-1 font-semibold">
                <i class="fas fa-arrow-up"></i>
                {{ stats.new_jobs_this_week }} this week
            </span>
            {% endif %}
        </div>
        <div class="mt-3 progress-bar">
            {% set jobs_progress = ((stats.open_jobs or 0) / 50 * 100) %}
            {% set jobs_progress = jobs_progress if jobs_progress <= 100 else 100 %}
            <div class="progress-fill" style="width: {{ jobs_progress }}%"></div>
        </div>
    </div>
                    
    <div class="metric-card card rounded-xl bg-gray-900/80 p-4 sm:p-5 border border-gray-800 hover:border-red-600/50" onclick="window.location.href='{{ url_for('applicants') }}'">
        <div class="flex items-center justify-between mb-2">
            <p class="text-xs text-gray-400 uppercase tracking-wide font-semibold">Total Applicants</p>
            <i class="fas fa-users text-blue-400 text-lg"></i>
        </div>
        <div class="flex items-end justify-between">
            <p class="text-3xl font-bold text-white">{{ stats.total_applicants or 0 }}</p>
            {% if trends.applications %}
            <span class="text-xs {{ 'text-green-400' if trends.applications.direction == 'up' else 'text-red-400' if trends.applications.direction == 'down' else 'text-gray-400' }} flex items-center gap-1 font-semibold">
                <i class="fas fa-arrow-{{ 'up' if trends.applications.direction == 'up' else 'down' if trends.applications.direction == 'down' else 'right' }}"></i>
                {{ trends.applications.change|abs }}%
            </span>
            {% endif %}
        </div>
        <div class="mt-3 progress-bar">
            {% set applicants_progress = ((stats.total_applicants or 0) / 200 * 100) %}
            {% set applicants_progress = applicants_progress if applicants_progress <= 100 else 100 %}
            <div class="progress-fill" style="width: {{ applicants_progress }}%"></div>
        </div>
    </div>
                    
    <div class="metric-card card rounded-xl bg-gray-900/80 p-4 sm:p-5 border border-gray-800 hover:border-red-600/50" onclick="window.location.href='{{ url_for('applicants') }}'">
        <div class="flex items-center justify-between mb-2">
            <p class="text-xs text-gray-400 uppercase tracking-wide font-semibold">Hired</p>
            <i class="fas fa-check-circle text-green-400 text-lg"></i>
        </div>
        <div class="flex items-end justify-between">
            <p class="text-3xl font-bold text-green-400">{{ stats.hired_applications or stats.accepted_applications or 0 }}</p>
            {% if stats.success_rate %}
            <span class="text-xs text-green-400 font-semibold">{{ stats.success_rate }}% rate</span>
            {% endif %}
        </div>
        <div class="mt-3 progress-bar">
            {% set total_apps = stats.total_applications or 1 %}
            {% set accepted_progress = (((stats.hired_applications or stats.accepted_applications or 0) / total_apps * 100) if total_apps > 0 else 0) %}
            {% set accepted_progress = accepted_progress if accepted_progress <= 100 else 100 %}
            <div class="progress-fill bg-green-600" style="width: {{ accepted_progress }}%"></div>
        </div>
    </div>
                    
    <div class="metric-card card rounded-xl bg-gray-900/80 p-4 sm:p-5 border border-gray-800 hover:border-red-600/50" onclick="window.location.href='{{ url_for('admin_interviews') }}'">
        <div class="flex items-center justify-between mb-2">
            <p class="text-xs text-gray-400 uppercase tracking-wide font-semibold">Interviews Today</p>
            <i class="fas fa-calendar-check text-purple-400 text-lg"></i>
        </div>
        <div class="flex items-end justify-between">
            <p class="text-3xl font-bold text-white">{{ stats.interviews_today or 0 }}</p>
            {% if stats.total_interviews %}
            <span class="text-xs text-gray-400 font-semibold">{{ stats.total_interviews }} total</span>
            {% endif %}
        </div>
        <div class="mt-3 progress-bar">
            {% set interviews_progress = ((stats.interviews_today or 0) / 10 * 100) %}
            {% set interviews_progress = interviews_progress if interviews_progress <= 100 else 100 %}
            <div class="progress-fill bg-purple-600" style="width: {{ interviews_progress }}%"></div>
        </div>
    </div>
</section>


<!-- Main Content Grid -->
<section class="content-section grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-4">
    <!-- Recent Activity Stream -->
    <div class="lg:col-span-2 space-y-3 sm:space-y-4">
        <article class="card rounded-xl bg-gray-900/80 p-3 sm:p-4 border border-gray-800">
            <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4">
                <h2 class="text-base sm:text-lg font-semibold flex items-center gap-2">
                    <i class="fas fa-stream text-red-400"></i>
                    Recent Activity Stream
                </h2>
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <label for="activity-filter" class="sr-only">Filter activity by type</label>
                    <select id="activity-filter" name="activity-filter" aria-label="Filter activity by type" class="w-full sm:w-auto px-3 py-2 rounded-lg text-xs sm:text-sm bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all">
                        <option value="all">All Activity</option>
                        <option value="application">Applications</option>
                        <option value="interview">Interviews</option>
                        <option value="job">Jobs</option>
                    </select>
                </div>
            </header>
            {% if recent_activity %}
            <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                {% for activity in recent_activity %}
                <div class="activity-item border border-gray-800 rounded-lg p-3 sm:p-4 hover:bg-gray-800/50 transition-all cursor-pointer" data-type="{{ activity.type }}">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0 {{
                            'bg-blue-600/20 text-blue-400 border border-blue-600/30' if activity.type == 'application' else (
                            'bg-purple-600/20 text-purple-400 border border-purple-600/30' if activity.type == 'interview' else 'bg-green-600/20 text-green-400 border border-green-600/30')
                        }}">
                            <i class="fas text-sm {{
                                'fa-file-alt' if activity.type == 'application' else (
                                'fa-calendar-check' if activity.type == 'interview' else 'fa-briefcase')
                            }}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm sm:text-base text-white font-medium mb-2 leading-relaxed">{{ activity.description }}</p>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 flex-wrap">
                                <span class="text-xs text-gray-400 flex items-center gap-1">
                                    <i class="fas fa-clock"></i>
                                    <span>{{ activity.timestamp }}</span>
                                </span>
                                {% set status_key = activity.status_key or activity.status %}
                                {% if status_key %}
                                {% set badge_class = {
                                    'pending': 'bg-yellow-600/20 text-yellow-400 border border-yellow-600/30',
                                    'scheduled': 'bg-purple-600/20 text-purple-400 border border-purple-600/30',
                                    'interviewed': 'bg-cyan-600/20 text-cyan-400 border border-cyan-600/30',
                                    'applied': 'bg-blue-600/20 text-blue-400 border border-blue-600/30',
                                    'under_review': 'bg-yellow-600/20 text-yellow-400 border border-yellow-600/30',
                                    'interview': 'bg-purple-600/20 text-purple-400 border border-purple-600/30',
                                    'hired': 'bg-green-600/20 text-green-400 border border-green-600/30',
                                    'accepted': 'bg-green-600/20 text-green-400 border border-green-600/30',
                                    'rejected': 'bg-red-600/20 text-red-400 border border-red-600/30'
                                }.get((status_key|lower), 'bg-gray-600/20 text-gray-300 border border-gray-600/30') %}
                                <span class="px-2 py-1 rounded-full text-xs font-semibold border {{ badge_class }}">
                                    {{ activity.status_label or status_key|replace('_', ' ')|title }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-inbox text-5xl mb-4 opacity-50"></i>
                <p class="text-base font-medium mb-1">No recent activity</p>
                <p class="text-sm text-gray-500">Activity will appear here as it happens</p>
            </div>
            {% endif %}
        </article>

        <!-- Pending Applications -->
        <article class="card rounded-xl bg-gray-900/80 p-3 sm:p-4 border border-gray-800">
            <header class="flex items-center justify-between mb-3">
                <h2 class="text-base sm:text-lg font-semibold flex items-center gap-2">
                    <i class="fas fa-clock text-yellow-400"></i>
                    Pending Applications
                </h2>
                <a href="{{ url_for('applicants') }}" class="text-sm text-red-400 hover:text-red-300 font-semibold transition-colors">View All <i class="fas fa-arrow-right ml-1"></i></a>
            </header>
            {% if recent_apps %}
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 text-xs uppercase tracking-wide border-b border-gray-800">
                            <th class="py-3 text-left px-2 font-semibold">Applicant</th>
                            <th class="py-3 text-left px-2 font-semibold">Job Position</th>
                            <th class="py-3 text-left px-2 font-semibold">Status</th>
                            <th class="py-3 text-left px-2 font-semibold">Submitted</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800">
                        {% for application in recent_apps %}
                        <tr class="hover:bg-gray-800/50 transition-colors cursor-pointer" onclick="window.location.href='{{ url_for('applicants') }}'">
                            <td class="py-4 px-2 text-white font-medium">{{ application.applicant_name }}</td>
                            <td class="py-4 px-2 text-gray-300">{{ application.position_applied }}</td>
                            <td class="py-4 px-2">
                                {# Harmonize status like Applications page and auto-mark Interviewed #}
                                {% set status_config = {
                                    'pending': {'class': 'bg-yellow-600/20 text-yellow-400 border-yellow-600/30', 'label': 'Pending'},
                                    'interviewed': {'class': 'bg-cyan-600/20 text-cyan-400 border-cyan-600/30', 'label': 'Interviewed'},
                                    'hired': {'class': 'bg-green-600/20 text-green-400 border-green-600/30', 'label': 'Hired'},
                                    'rejected': {'class': 'bg-red-600/20 text-red-400 border-red-600/30', 'label': 'Rejected'},
                                    'reviewed': {'class': 'bg-yellow-600/20 text-yellow-400 border-yellow-600/30', 'label': 'Pending'},
                                    'shortlisted': {'class': 'bg-yellow-600/20 text-yellow-400 border-yellow-600/30', 'label': 'Pending'},
                                    'accepted': {'class': 'bg-green-600/20 text-green-400 border-green-600/30', 'label': 'Hired'},
                                    'applied': {'class': 'bg-yellow-600/20 text-yellow-400 border-yellow-600/30', 'label': 'Pending'},
                                    'under_review': {'class': 'bg-yellow-600/20 text-yellow-400 border-yellow-600/30', 'label': 'Pending'},
                                    'interview': {'class': 'bg-cyan-600/20 text-cyan-400 border-cyan-600/30', 'label': 'Interviewed'}
                                } %}
                                {% set raw_key = (application.status_key or application.status or 'pending')|lower|trim %}
                                {# Don't auto-map to interviewed - respect the actual status (scheduled/interviewed) #}
                                {# Status flow: pending -> scheduled (when interview scheduled) -> interviewed (when interview completed) #}
                                {% set display_key = raw_key %}
                                {% set status_meta = status_config.get(display_key, {'class': 'bg-gray-600/20 text-gray-300 border-gray-600/30', 'label': display_key|replace('_',' ')|title}) %}
                                <span class="px-2 py-1 rounded-full text-xs font-semibold border {{ status_meta.class }}">
                                    {{ status_meta.label }}
                                </span>
                            </td>
                            <td class="py-4 px-2 text-gray-400 text-xs">{{ application.submitted_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-10 text-gray-400">
                <i class="fas fa-check-circle text-4xl mb-3 opacity-50"></i>
                <p>No pending applications</p>
                <p class="text-xs text-gray-500 mt-2">All applications have been reviewed</p>
            </div>
            {% endif %}
        </article>
    </div>

    <!-- Sidebar -->
    <aside class="space-y-3 sm:space-y-4">
        <!-- Active Sessions Monitor -->
        {% if user and user.role == 'admin' and active_sessions %}
        <article class="card rounded-2xl bg-gray-900/80 p-4 sm:p-6 border border-gray-800">
            <header class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fas fa-users-cog text-green-400"></i>
                    Active Sessions
                </h2>
                <span class="px-2 py-1 rounded-full text-xs bg-green-600/20 text-green-400 border border-green-600/30 font-semibold">{{ active_sessions|length }}</span>
            </header>
            <div class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar">
                {% for session in active_sessions %}
                <div class="flex items-center gap-3 p-3 border border-gray-800 rounded-lg hover:bg-gray-800/50 transition-colors">
                    <div class="w-8 h-8 rounded-full bg-green-600/20 border border-green-600/30 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-circle text-green-400 text-xs animate-pulse"></i>
                            </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-white font-medium">{{ (session.user_type or 'User')|title }}</p>
                        <p class="text-xs text-gray-400 truncate">{{ session.email or '' }} · {{ session.login_time }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </article>
        {% endif %}

        <!-- Upcoming Interviews -->
        <article class="card rounded-2xl bg-gray-900/80 p-4 sm:p-6 border border-gray-800">
            <header class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fas fa-calendar-check text-purple-400"></i>
                    Upcoming Interviews
                </h2>
                <a href="{{ url_for('admin_interviews') }}" class="text-sm text-red-400 hover:text-red-300 font-semibold transition-colors">View All <i class="fas fa-arrow-right ml-1"></i></a>
            </header>
            {% if interviews %}
            <div class="space-y-3">
                {% for interview in interviews %}
                <div class="border border-red-600/40 bg-red-900/20 rounded-xl p-4 hover:bg-red-900/30 transition-all">
                    <p class="text-sm text-gray-400 mb-1"><i class="fas fa-clock mr-1"></i>{{ interview.date_time or 'To be scheduled' }}</p>
                    <h3 class="font-semibold text-white">{{ interview.applicant_name }}</h3>
                    <p class="text-sm text-gray-300 mt-1 truncate">{{ interview.position_applied }}</p>
                    <div class="flex items-center gap-2 mt-2 flex-wrap">
                        <span class="px-2 py-1 rounded-full text-xs bg-purple-600/20 text-purple-400 border border-purple-600/30 font-semibold">{{ interview.type or 'In-Person' }}</span>
                        {% if interview.location %}
                        <span class="text-xs text-gray-400"><i class="fas fa-map-marker-alt"></i> {{ interview.location }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-6 text-gray-400">
                <i class="fas fa-calendar-times text-3xl mb-2 opacity-50"></i>
                <p class="text-sm">No upcoming interviews</p>
            </div>
            {% endif %}
        </article>

    </aside>
</section>
{% endblock %}

{% block extra_js %}
<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #dc2626; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #ef4444; }
</style>
<script>
    // Activity filter
    document.getElementById('activity-filter')?.addEventListener('change', function(e) {
        const filter = e.target.value;
        document.querySelectorAll('.activity-item').forEach(item => {
            if (filter === 'all' || item.dataset.type === filter) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Refresh dashboard - optimized to avoid requestAnimationFrame violation
    function refreshDashboard() {
        const btn = event.target.closest('button');
        if (btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            btn.disabled = true;
        }
        // Direct reload without requestAnimationFrame to avoid performance warnings
        window.location.reload();
    }
</script>
{% endblock %}
